# Classification Worker 配置
# 复制此文件为 wrangler.classification.toml 并填入你的配置
# 消费 classification 队列，使用 AI 对 skill 进行分类
#
# AI 分类 Fallback 策略:
# 1. 使用配置的主模型调用 OpenRouter
# 2. 失败后在同一模型上重试一次
# 3. 从免费模型池中随机选择另一个模型重试
# 4. 使用 DeepSeek 官方 API (deepseek-chat) 作为兜底
# 5. 最终降级到关键词分类
#
# 注意: 推荐使用 OpenRouter 免费模型，无需付费

name = "skillscat-classification"
main = "workers/classification.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]

workers_dev = false
preview_urls = false

[observability]
enabled = true
head_sampling_rate = 1

# Queue Consumer - 消费 classification 队列

[[queues.consumers]]
queue = "skillscat-classification"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 3
dead_letter_queue = "skillscat-classification-dlq"

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "skillscat-db"
database_id = "<your-database-id>"

# R2 Storage - 读取缓存的 SKILL.md 内容
[[r2_buckets]]
binding = "R2"
bucket_name = "skillscat-storage"

# KV Namespace
[[kv_namespaces]]
binding = "KV"
id = "<your-kv-namespace-id>"

# 必需 (如果使用 OpenRouter): 指定使用的模型
# 查看可用免费模型: https://openrouter.ai/models?q=:free
# [vars]
# AI_MODEL = "liquid/lfm-2.5-1.2b-thinking:free"
# FREE_MODELS = "liquid/lfm-2.5-1.2b-thinking:free,google/gemma-3-1b-it:free,meta-llama/llama-3.2-1b-instruct:free"

[env.production]
name = "skillscat-classification-production"

[[env.production.queues.consumers]]
queue = "skillscat-classification"
max_batch_size = 5
max_batch_timeout = 60
max_retries = 3
dead_letter_queue = "skillscat-classification-dlq"

[[env.production.d1_databases]]
binding = "DB"
database_name = "skillscat-db"
database_id = "<your-production-database-id>"

[[env.production.r2_buckets]]
binding = "R2"
bucket_name = "skillscat-storage"

[[env.production.kv_namespaces]]
binding = "KV"
id = "<your-production-kv-namespace-id>"
